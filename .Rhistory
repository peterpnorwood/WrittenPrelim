coef(msm_poisson)
coef(msm_nb)
## create plots showing the estimated relationship
smk_seq <- seq(min(newdat$smokeintensity)-2.5,
max(newdat$smokeintensity)+2.5,
length.out=1e3)
dummy1 <- data.frame(smokeintensity=smk_seq,method="Random Forest")
dummy1$p <- predict(msm_rf,newdata = dummy1)
dummy2 <- data.frame(smokeintensity=smk_seq,method="Normal")
dummy2$p <- predict(msm_lm,newdata = dummy2)
dummy3 <- data.frame(smokeintensity=smk_seq,method="Poisson")
dummy3$p <- predict(msm_poisson,newdata = dummy3)
dummy4 <- data.frame(smokeintensity=smk_seq,method="Negative Binomial")
dummy4$p <- predict(msm_nb,newdata = dummy4)
dummy <- rbind(dummy1,dummy2,dummy3,dummy4)
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
#facet_wrap(vars(method)) +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw()
## fit the marginal structural model
msm_lm <- geeglm(wt82_71 ~ smokeintensity + I(smokeintensity**2),
data = newdat,
weights = sw_a_lm,
id = seqn,
corstr = "independence")
msm_lm
dummy2 <- data.frame(smokeintensity=smk_seq,method="Normal")
dummy2$p <- predict(msm_lm,newdata = dummy2)
dummy3 <- data.frame(smokeintensity=smk_seq,method="Poisson")
dummy3$p <- predict(msm_poisson,newdata = dummy3)
dummy4 <- data.frame(smokeintensity=smk_seq,method="Negative Binomial")
dummy4$p <- predict(msm_nb,newdata = dummy4)
dummy <- rbind(dummy1,dummy2,dummy3,dummy4)
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
#facet_wrap(vars(method)) +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw()
predict(msm_lm,newdata = dummy2)
## create plots showing the estimated relationship
smk_seq <- seq(min(newdat$smokeintensity)-2.5,
max(newdat$smokeintensity)+2.5,
length.out=1e3)
dummy1 <- data.frame(smokeintensity=smk_seq,method="Random Forest")
dummy1$p <- predict(msm_rf,newdata = dummy1)
dummy2 <- data.frame(smokeintensity=smk_seq,method="Normal")
dummy2$p <- predict(msm_lm,newdata = dummy2)
dummy3 <- data.frame(smokeintensity=smk_seq,method="Poisson")
dummy3$p <- predict(msm_poisson,newdata = dummy3)
dummy4 <- data.frame(smokeintensity=smk_seq,method="Negative Binomial")
dummy4$p <- predict(msm_nb,newdata = dummy4)
dummy <- rbind(dummy1,dummy2,dummy3,dummy4)
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
#facet_wrap(vars(method)) +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw()
table(dummy$method)
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
#facet_wrap(vars(method)) +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw()
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
facet_wrap(vars(method)) +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw()
summary(newdat$sw_a_poisson)
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
facet_wrap(vars(method)) +
geom_hline(yintercept = 0,color="black") +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw()
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
facet_wrap(vars(method)) +
geom_hline(yintercept = 0,color="black",linetype="dotted") +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw()
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
facet_wrap(vars(method)) +
geom_hline(yintercept = 0,color="black",linetype="dotted") +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change",
color="Method") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw() +
theme(legend.position = NULL)
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
facet_wrap(vars(method)) +
geom_hline(yintercept = 0,color="black",linetype="dotted") +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw() +
theme(legend.position = NULL)
## for the statisticians
ggplot(data=dummy) +
geom_line(aes(x=smokeintensity,y=p,color=method)) +
facet_wrap(vars(method)) +
geom_hline(yintercept = 0,color="black",linetype="dotted") +
labs(x="Smoking Intensity at Baseline", y="Estimated Mean Weight Change") +
ggtitle("Weight Change vs Smoking Intensity") +
theme_bw() +
theme(legend.position = "none")
hist(newdat$sw_a_nb)
summary(newdat$sw_a_nb)
summary(newdat$sw_a_lm)
summary(newdat$sw_a_rf)
summary(newdat$sw_a_poisson)
summary(msm_nb)
## for others
ggplot(data=dummy %>% filter(method=="Negative Binomial")) +
geom_line(aes(x=smokeintensity,y=p)) +
geom_vline(xintercept = xmax_nb,color="red") +
labs(x="Cigarettes Per Day in 1971", y="(Weight @ 1982) - (Weight @ 1971)") +
ggtitle("Weight (kg) Change vs Smoking Intensity") +
theme_bw()
xmax_nb <- -coef(msm_nb)[2]/(2*coef(msm_nb)[3])
## for others
ggplot(data=dummy %>% filter(method=="Negative Binomial")) +
geom_line(aes(x=smokeintensity,y=p)) +
geom_vline(xintercept = xmax_nb,color="red") +
labs(x="Cigarettes Per Day in 1971", y="(Weight @ 1982) - (Weight @ 1971)") +
ggtitle("Weight (kg) Change vs Smoking Intensity") +
theme_bw()
dummy %>% filter(method=="Negative Binomial")
dummy %>% filter(method=="Negative Binomial" & p < 0.1)
dummy %>% filter(method=="Negative Binomial" & 0 < p < 0.1)
dummy %>% filter(method=="Negative Binomial" & p < 0.1 & p>0)
## ----------------------------------------------------------------- ##
## run_sims.R ------------------------------------------------------ ##
## Author: Peter Norwood, NC State University ---------------------- ##
## Purpose: run a simulation experiment with certain inputs -------- ##
## ----------------------------------------------------------------- ##
## load functions
setwd("~/Research/Written Prelim/WrittenPrelim")
source("sims.R")
library(parallel)
## run the simulations
## parameters
p=8
K=8
N=1000
sd_X=1
sd_Y=0.5
t0=(p+1)*K*3+100
eps=0.05
al=0.01
N_post=500
M=100
## how many simulations to run
r <- 5
## Simulate the experiments
start <- Sys.time()
sims <- mclapply(X=1:r,
function(X){sim(N=N,p=p,K=K,sd_X=sd_X,sd_Y=sd_Y,
t0=t0,eps=eps,al=al,N_post=N_post,M=M)},
mc.cores = 1
)
## ----------------------------------------------------------------- ##
## run_sims.R ------------------------------------------------------ ##
## Author: Peter Norwood, NC State University ---------------------- ##
## Purpose: run a simulation experiment with certain inputs -------- ##
## ----------------------------------------------------------------- ##
## load functions
setwd("~/Research/Written Prelim/WrittenPrelim")
source("sims.R")
library(parallel)
## run the simulations
## parameters
p=2
K=2
N=1000
sd_X=1
sd_Y=0.5
t0=(p+1)*K*3+100
eps=0.05
al=0.01
N_post=500
M=100
## how many simulations to run
r <- 5
## Simulate the experiments
start <- Sys.time()
sims <- mclapply(X=1:r,
function(X){sim(N=N,p=p,K=K,sd_X=sd_X,sd_Y=sd_Y,
t0=t0,eps=eps,al=al,N_post=N_post,M=M)},
mc.cores = 1
)
## ----------------------------------------------------------------- ##
## run_sims.R ------------------------------------------------------ ##
## Author: Peter Norwood, NC State University ---------------------- ##
## Purpose: run a simulation experiment with certain inputs -------- ##
## ----------------------------------------------------------------- ##
## load functions
setwd("~/Research/Written Prelim/WrittenPrelim")
source("sims.R")
library(parallel)
## run the simulations
## parameters
p=2
K=2
N=1000
sd_X=1
sd_Y=0.5
t0=(p+1)*K*3+100
eps=0.05
al=0.01
N_post=500
M=100
## how many simulations to run
r <- 5
## Simulate the experiments
start <- Sys.time()
sims <- mclapply(X=1:r,
function(X){sim(N=N,p=p,K=K,sd_X=sd_X,sd_Y=sd_Y,
t0=t0,eps=eps,al=al,N_post=N_post,M=M)},
mc.cores = 1
)
end <- Sys.time()
## check bad sims
good_sets <- c()
tick=1
for(i in 1:r){
check <- c()
for(j in 1:6){
check[j] <- is.data.frame(sims[[i]]$exp[[j]])
}
if(sum(check)==6){
good_sets[tick]=i
tick=tick+1
}else{
## no nothing
}
}
## collect experiment information into one dataframe
exps <- data.frame()
post <- data.frame()
tick <- 1
for(i in good_sets){
## check convergence for simple randomization
exp_simple <- sims[[i]]$exp$train_set
fit <- lm(Y~-1+as.factor(A)+as.factor(A):.-as.factor(A):A,
data=exp_simple)
## gather parameter convergence information
coef_fit <- coef(fit)
theta_hat <- c()
## put them in the same format as the theta vector
tik <- 1
for(ii in 1:K){
for(jj in 0:p){
theta_hat[tik] <- coef_fit[ii+(K)*jj]
tik=tik+1
}
}
## simple norm
simple_norm <- norm(matrix(sims[[i]]$theta-theta_hat),type="F")
## collect experiment information
## pronzato
exp_pronzato <- sims[[i]]$exp$pronzato
exp_pronzato$R <- NA
exp_pronzato$method <- "pronzato"
exp_pronzato$rep <- tick
exp_pronzato$simple_norm <- simple_norm
post_pronzato <- sims[[i]]$post$pronzato
post_pronzato$method <- "pronzato"
post_pronzato$rep <- tick
## e_greedy
exp_e_greedy <- sims[[i]]$exp$e_greedy
exp_e_greedy$R <- NA
exp_e_greedy$method <- "e_greedy"
exp_e_greedy$rep <- tick
exp_e_greedy$simple_norm <- simple_norm
post_e_greedy <- sims[[i]]$post$e_greedy
post_e_greedy$method <- "e_greedy"
post_e_greedy$rep <- tick
## greedy
exp_greedy <- sims[[i]]$exp$greedy
exp_greedy$R <- NA
exp_greedy$method <- "greedy"
exp_greedy$rep <- tick
exp_greedy$simple_norm <- simple_norm
post_greedy <- sims[[i]]$post$greedy
post_greedy$method <- "greedy"
post_greedy$rep <- tick
## greedy first
exp_greedy_first <- sims[[i]]$exp$greedy_first
exp_greedy_first$method <- "greedy_first"
exp_greedy_first$rep <- tick
exp_greedy_first$simple_norm <- simple_norm
post_greedy_first <- sims[[i]]$post$greedy_first
post_greedy_first$method <- "greedy_first"
post_greedy_first$rep <- tick
## IDS_freq
exp_IDS_freq <- sims[[i]]$exp$IDS_freq
exp_IDS_freq$R <- NA
exp_IDS_freq$method <- "IDS_freq"
exp_IDS_freq$rep <- tick
exp_IDS_freq$simple_norm <- simple_norm
post_IDS_freq <- sims[[i]]$post$IDS_freq
post_IDS_freq$method <- "IDS_freq"
post_IDS_freq$rep <- tick
## IDS_bayes
exp_IDS_bayes <- sims[[i]]$exp$IDS_bayes
exp_IDS_bayes$R <- NA
exp_IDS_bayes$method <- "IDS_bayes"
exp_IDS_bayes$rep <- tick
exp_IDS_bayes$simple_norm <- simple_norm
post_IDS_bayes <- sims[[i]]$post$IDS_bayes
post_IDS_bayes$method <- "IDS_bayes"
post_IDS_bayes$rep <- tick
## simple
post_simple <- sims[[i]]$post$simple
post_simple$method <- "simple"
post_simple$rep <- tick
## create out of trial information
## attach these datasets to the bigger one
exps <- rbind(exps,exp_pronzato,exp_greedy,exp_e_greedy,
exp_greedy_first,exp_IDS_freq,exp_IDS_bayes)
post <- rbind(post,post_pronzato,post_greedy,post_e_greedy,
post_greedy_first,post_IDS_freq,post_IDS_bayes,post_simple)
## update the tick
tick=tick+1
}
## save trial information
exps$K<- K
exps$p <- p
post$K <- K
post$p <- p
save(exps,file=paste0("exps_K=",K,"_p=",p,".RData"))
save(post,file=paste0("post_K=",K,"_p=",p,".RData"))
# burn_in=(p+1)*K*3
#
# exps %>%
#   filter(sub>burn_in) %>%
#   group_by(method) %>%
#   summarise(mean(regret))
#
# exps %>%
#   filter(sub>t0 & method=="greedy_first") %>%
#   summarise(mean(R))
#
# convergence <- exps %>%
#   filter(sub>burn_in) %>%
#   group_by(method,sub) %>%
#   summarise(norm=mean(norm))
#
# ggplot(exps %>% filter(sub==N)) +
#   geom_boxplot(aes(x=method,y=norm/simple_norm))
#
# regret <- exps %>%
#   filter(sub>burn_in) %>%
#   group_by(method,rep) %>%
#   mutate(cum_regret=cumsum(regret)) %>%
#   group_by(method,sub) %>%
#   summarise(cum_regret=mean(cum_regret))
#
# opt <- exps %>%
#   filter(sub>burn_in) %>%
#   mutate(opt=ifelse(regret==0,1,0)) %>%
#   group_by(method,rep) %>%
#   mutate(cum_opt=cumsum(opt),
#          cum_prop=cum_opt/sub) %>%
#   group_by(method,sub) %>%
#   summarise(cum_opt=mean(cum_prop))
#
# ggplot(data=opt) +
#   geom_line(aes(x=sub,y=cum_opt,color=method))
#
# ggplot(data=convergence) +
#   geom_line(aes(x=sub,y=norm,color=method))
#
# ggplot(data=regret) +
#   geom_line(aes(x=sub,y=cum_regret,color=method))
#
#
# post %>%
#   group_by(method) %>%
#   summarise(mean(correct))
#
# post %>%
#   group_by(method) %>%
#   summarise(mean(regret))
## create "scenario" variable
exps <- exps %>%
mutate(scenario=paste0("K=",K," p=",p),
burn_in=3*(p+1)*K)
## analyze cumulative regret
regret <- exps %>% filter(sub>burn_in) %>%
group_by(scenario,method,rep) %>%
mutate(cum_regret=cumsum(regret)) %>%
group_by(scenario,method,sub) %>%
summarise(mean_regret=mean(cum_regret),
median_regret=median(cum_regret),
sd_regret=sd(cum_regret))
regret %>% filter(sub==1000)%>%
select(scenario,method,mean_regret,median_regret,sd_regret) %>%
xtable(digits=3)
regret %>% filter(sub==1000)%>%
select(scenario,method,mean_regret,median_regret,sd_regret)
ggplot(data=regret) +
geom_line(aes(x=sub,y=mean_regret,color=method)) +
facet_wrap(vars(scenario),scales="free")
correct %>% filter(sub==1000)%>%
select(scenario,method,mean_correct,median_correct,sd_correct)
## analyze proportion of correctimal intervention
correct <- exps %>% filter(sub>burn_in) %>%
group_by(scenario,method,rep) %>%
mutate(correct=ifelse(regret==0,1,0),
cum_correct=cumsum(correct),
prop_correct=cum_correct/sub) %>%
group_by(scenario,method,sub) %>%
summarise(mean_correct=mean(prop_correct),
median_correct=median(prop_correct),
sd_correct=sd(prop_correct))
correct %>% filter(sub==1000)%>%
select(scenario,method,mean_correct,median_correct,sd_correct)
ggplot(data=correct) +
geom_line(aes(x=sub,y=mean_correct,color=method)) +
facet_wrap(vars(scenario),scales="free")
## analyze convergence
theta <- exps %>% filter(sub>burn_in & method!="greedy_first") %>%
group_by(scenario,method,sub) %>%
mutate(rel_efficiency=simple_norm/norm) %>%
summarise(mean_norm=mean(norm),
median_norm=median(norm),
sd_norm=sd(norm),
mean_simple_norm=mean(simple_norm)) %>%
mutate(rel_eff=mean_simple_norm/mean_norm)
## analyze convergence
theta <- exps %>% filter(sub>burn_in) %>%
group_by(scenario,method,sub) %>%
mutate(rel_efficiency=simple_norm/norm) %>%
summarise(mean_norm=mean(norm),
median_norm=median(norm),
sd_norm=sd(norm),
mean_simple_norm=mean(simple_norm)) %>%
mutate(rel_eff=mean_simple_norm/mean_norm)
theta %>% filter(sub==1000)%>%
select(scenario,method,mean_norm,median_norm,sd_norm,rel_eff)
ggplot(data=theta) +
geom_line(aes(x=sub,y=mean_norm,color=method)) +
facet_wrap(vars(scenario),scales="free")
## put them all together
post <- rbind(post22,post28,post82,post88)
post
## create scenario column
## create "scenario" variable
post <- post %>%
mutate(scenario=paste0("K=",K," p=",p))
correct_post <- post %>%
group_by(method,scenario,rep) %>%
summarise(prop_correct=mean(correct)) %>%
group_by(scenario,method) %>%
summarise(mean_correct=mean(prop_correct),
median_correct=median(prop_correct),
sd_correct=sd(prop_correct))
regret_post <- post %>%
group_by(method,scenario,rep) %>%
summarise(regret=sum(regret)) %>%
group_by(scenario,method) %>%
summarise(mean_cum_regret=mean(regret),
median_cum_regret=median(regret),
sd_cum_regret=sd(regret))
post %>%
group_by(method,scenario,rep) %>%
summarise(prop_correct=mean(correct)) %>%
group_by(scenario,method) %>%
summarise(mean_correct=mean(prop_correct),
median_correct=median(prop_correct),
sd_correct=sd(prop_correct))
post %>%
group_by(method,scenario,rep) %>%
summarise(regret=sum(regret)) %>%
group_by(scenario,method) %>%
summarise(mean_cum_regret=mean(regret),
median_cum_regret=median(regret),
sd_cum_regret=sd(regret))
post %>%
group_by(method,scenario,rep) %>%
summarise(regret=sum(regret)) %>%
group_by(scenario,method) %>%
summarise(mean_cum_regret=mean(regret),
median_cum_regret=median(regret),
sd_cum_regret=sd(regret))
